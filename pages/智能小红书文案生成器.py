import streamlit as st
from streamlit import spinner
from utils.utils_xiaohongshu import generate_copywriting

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(
    page_title="å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨",
    page_icon="ğŸ“",
    layout="wide",
    initial_sidebar_state="expanded"
)


# ä¾§è¾¹æ 
with st.sidebar:
    opneai_api_key = st.text_input("è¯·è¾“å…¥ä½ çš„OpenAI APIå¯†é’¥ï¼š", type="password")
    st.markdown("[è·å–Openai APIå¯†é’¥](https://platform.openai.com/api-keys)")
    clear_button = st.button("ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å†…å®¹", type="secondary")

#åº”ç”¨æ ‡é¢˜
st.title("ğŸ“ å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆå™¨")
st.markdown("ğŸ’¡ è®©AIå¸®ä½ é«˜æ•ˆç”Ÿæˆä¼˜è´¨å°çº¢ä¹¦æ–‡æ¡ˆï¼Œé€‚ç”¨äºäº§å“æ¨å¹¿ã€ç»éªŒæ•™ç¨‹ã€æ—…è¡Œæ”»ç•¥ã€ç”Ÿæ´»è®°å½•ç­‰å¤šç§åœºæ™¯ã€‚")
st.divider()

# é€‰æ‹©å†…å®¹ç±»å‹
st.markdown("### ğŸ“‹ é€‰æ‹©å†…å®¹ç±»å‹")
content_type = st.radio(
    "è¯·é€‰æ‹©ä½ è¦ç”Ÿæˆçš„æ–‡æ¡ˆç±»å‹ï¼š",
    ["ğŸ›ï¸ äº§å“æ¨å¹¿", "ğŸ“š ç»éªŒæ•™ç¨‹", "ğŸŒ æ—…è¡Œæ”»ç•¥", "ğŸ“– ç”Ÿæ´»è®°å½•"],
    index=0,
    horizontal=True
)
# å»é™¤iconåç¼€ï¼Œä¾¿äºåç»­é€»è¾‘å¤„ç†
content_type_map = {
    "ğŸ›ï¸ äº§å“æ¨å¹¿": "äº§å“æ¨å¹¿",
    "ğŸ“š ç»éªŒæ•™ç¨‹": "ç»éªŒæ•™ç¨‹",
    "ğŸŒ æ—…è¡Œæ”»ç•¥": "æ—…è¡Œæ”»ç•¥",
    "ğŸ“– ç”Ÿæ´»è®°å½•": "ç”Ÿæ´»è®°å½•"
}
# è‹¥content_typeä¸ºNoneï¼Œé»˜è®¤äº§å“æ¨å¹¿
if content_type is None:
    content_type = "ğŸ›ï¸ äº§å“æ¨å¹¿"
content_type = content_type_map[content_type]
st.divider()

# å®šä¹‰å„ç±»å‹çš„è¾“å…¥å­—æ®µé…ç½®
form_config = {
    "äº§å“æ¨å¹¿": {
        "fields": ["äº§å“åç§°", "äº§å“ç±»åˆ«", "å–ç‚¹", "ç›®æ ‡äººç¾¤", "ç—›ç‚¹", "é£æ ¼è¦æ±‚"],
        "placeholders": {
            "äº§å“åç§°": "ä¾‹å¦‚ï¼šæ¶¦ç™¾é¢œç»å°¿é…¸æ¬¡æŠ›ç²¾å",
            "äº§å“ç±»åˆ«": "ç¾å¦†/æŠ¤è‚¤/ç¾é£Ÿ/ç©¿æ­ç­‰",
            "å–ç‚¹": "ä¿æ¹¿ã€ä¿®å¤ã€ç‹¬ç«‹åŒ…è£…ç­‰",
            "ç›®æ ‡äººç¾¤": "æ²¹çš®/å­¦ç”Ÿå…š/å®å¦ˆ",
            "ç—›ç‚¹": "å¡ç²‰ã€å‡ºæ²¹ã€æ•æ„Ÿç­‰",
            "é£æ ¼è¦æ±‚": "ç§è‰é£/æµ‹è¯„é£/å¹²è´§é£"
        },
        "icons": {
            "äº§å“åç§°": "ğŸ·ï¸",
            "äº§å“ç±»åˆ«": "ğŸ“¦",
            "å–ç‚¹": "â­",
            "ç›®æ ‡äººç¾¤": "ğŸ‘¥",
            "ç—›ç‚¹": "â—",
            "é£æ ¼è¦æ±‚": "ğŸ¨"
        }
    },
    "ç»éªŒæ•™ç¨‹": {
        "fields": ["æ•™ç¨‹ä¸»é¢˜", "ç›®æ ‡äººç¾¤", "å·¥å…·/ææ–™", "æ­¥éª¤è¦ç‚¹", "å¸¸è§é—®é¢˜", "é£æ ¼è¦æ±‚"],
        "placeholders": {
            "æ•™ç¨‹ä¸»é¢˜": "ä¾‹å¦‚ï¼š3æ­¥ç”»å¥½æˆªæ–­å¼çœ¼å¦†",
            "ç›®æ ‡äººç¾¤": "æ–°æ‰‹/è¿›é˜¶/ç†Ÿç»ƒ",
            "å·¥å…·/ææ–™": "ç²‰åº•æ£’ã€å§èš•ç¬”ç­‰",
            "æ­¥éª¤è¦ç‚¹": "1. ç²‰åº•æ£’å¿«é€Ÿä¸Šå¦†æŠ€å·§\n2. 3ç¬”æå®šå§èš•",
            "å¸¸è§é—®é¢˜": "å®¹æ˜“æ™•å¦†æ€ä¹ˆåŠï¼Ÿå§èš•ç”»ä¸å¥½ï¼Ÿ",
            "é£æ ¼è¦æ±‚": "ç®€æ´æ˜äº†/å¹½é»˜é£è¶£"
        },
        "icons": {
            "æ•™ç¨‹ä¸»é¢˜": "ğŸ“–",
            "ç›®æ ‡äººç¾¤": "ğŸ‘¥",
            "å·¥å…·/ææ–™": "ğŸ› ï¸",
            "æ­¥éª¤è¦ç‚¹": "ğŸ“",
            "å¸¸è§é—®é¢˜": "â“",
            "é£æ ¼è¦æ±‚": "ğŸ¨"
        }
    },
    "æ—…è¡Œæ”»ç•¥": {
        "fields": ["ç›®çš„åœ°", "æ—…è¡Œå¤©æ•°", "å¿…å»æ™¯ç‚¹", "ç¾é£Ÿæ¨è", "å®ç”¨Tips", "é£æ ¼è¦æ±‚"],
        "placeholders": {
            "ç›®çš„åœ°": "ä¾‹å¦‚ï¼šé’å²›è€åŸåŒºã€æ–°ç–†ä¼ŠçŠ",
            "æ—…è¡Œå¤©æ•°": "2å¤©1å¤œã€5å¤©4æ™š",
            "å¿…å»æ™¯ç‚¹": "ä¿¡å·å±±ã€å¤§å­¦è·¯ç­‰",
            "ç¾é£Ÿæ¨è": "æœ¬åœ°äººç§è—å’–å•¡é¦†ã€è€å­—å·é¤å…",
            "å®ç”¨Tips": "äº¤é€šæ–¹å¼ã€é—¨ç¥¨é¢„çº¦ã€é¿é›·æé†’",
            "é£æ ¼è¦æ±‚": "æ”»ç•¥å‹/ä½“éªŒå‹/æ‘„å½±æŒ‡å—"
        },
        "icons": {
            "ç›®çš„åœ°": "ğŸ“",
            "æ—…è¡Œå¤©æ•°": "â°",
            "å¿…å»æ™¯ç‚¹": "ğŸï¸",
            "ç¾é£Ÿæ¨è": "ğŸœ",
            "å®ç”¨Tips": "ğŸ’¡",
            "é£æ ¼è¦æ±‚": "ğŸ¨"
        }
    },
    "ç”Ÿæ´»è®°å½•": {
        "fields": ["ä¸»é¢˜å…³é”®è¯", "åœºæ™¯ç»†èŠ‚", "æ—¶é—´/åœ°ç‚¹", "æƒ…æ„ŸåŸºè°ƒ", "æƒ³ä¼ è¾¾çš„ç‚¹", "é£æ ¼è¦æ±‚"],
        "placeholders": {
            "ä¸»é¢˜å…³é”®è¯": "ä¾‹å¦‚ï¼šç‹¬å±…ç”Ÿæ´»ã€æƒ…ä¾£æ—¥å¸¸",
            "åœºæ™¯ç»†èŠ‚": "å‘¨å…­ä¸Šåˆå»èƒ¡åŒå’–å•¡åº—çœ‹ä¹¦çš„ç»†èŠ‚",
            "æ—¶é—´/åœ°ç‚¹": "å‘¨æœ«ã€åŒ—äº¬èƒ¡åŒ",
            "æƒ…æ„ŸåŸºè°ƒ": "æ²»æ„ˆã€æç¬‘ã€æ„ŸåŠ¨",
            "æƒ³ä¼ è¾¾çš„ç‚¹": "äº«å—ç‹¬å¤„ã€è®°å½•ç”Ÿæ´»",
            "é£æ ¼è¦æ±‚": "æ–‡è‰ºæ¸…æ–°/çœŸå®è®°å½•"
        },
        "icons": {
            "ä¸»é¢˜å…³é”®è¯": "ğŸ”‘",
            "åœºæ™¯ç»†èŠ‚": "ğŸ“·",
            "æ—¶é—´/åœ°ç‚¹": "ğŸ•’",
            "æƒ…æ„ŸåŸºè°ƒ": "ğŸ’–",
            "æƒ³ä¼ è¾¾çš„ç‚¹": "ğŸ“¢",
            "é£æ ¼è¦æ±‚": "ğŸ¨"
        }
    }
}

# å¤„ç†ä¾§è¾¹æ æ¸…é™¤æŒ‰é’®ï¼ˆæ”¾åœ¨æ‰€æœ‰è¡¨å•æ¸²æŸ“ä¹‹å‰ï¼ï¼‰
if clear_button:
    current_fields = form_config[content_type]["fields"]
    for field in current_fields:
        st.session_state[f"{content_type}_{field}"] = ""
    st.experimental_rerun()

# è¾“å…¥è¡¨å•
with st.container():
    st.markdown(f"### âœï¸ å¡«å†™{content_type}ä¿¡æ¯")
    with st.form("input_form"):
        col1, col2 = st.columns(2)
        user_input = {}
        current_fields = form_config[content_type]["fields"]
        placeholders = form_config[content_type]["placeholders"]
        icons = form_config[content_type]["icons"]
        # éå†å½“å‰å†…å®¹ç±»å‹çš„æ‰€æœ‰å­—æ®µ
        for i, field in enumerate(current_fields):
            label = f"{icons[field]} {field}"
            if i % 2 == 0:
                with col1:
                    user_input[field] = st.text_area(
                        label,
                        placeholder=placeholders[field],
                        key=f"{content_type}_{field}",
                        height=100
                    )
            else:
                with col2:
                    user_input[field] = st.text_area(
                        label,
                        placeholder=placeholders[field],
                        key=f"{content_type}_{field}",
                        height=100
                    )
        generate_button = st.form_submit_button("ğŸš€ ç”Ÿæˆæ–‡æ¡ˆ", use_container_width=True)

#ç”Ÿæˆæ–‡æ¡ˆé€»è¾‘
if generate_button and not opneai_api_key:
    st.info("è¯·è¾“å…¥ä½ çš„Open AIå¯†é’¥ï¼ï¼ï¼")
    st.stop()
if generate_button:
    # å®šä¹‰æ¯ç§å†…å®¹ç±»å‹çš„å¿…å¡«å­—æ®µ
    required_fields = {
        "äº§å“æ¨å¹¿": ["äº§å“åç§°", "äº§å“ç±»åˆ«", "å–ç‚¹", "ç›®æ ‡äººç¾¤", "ç—›ç‚¹", "é£æ ¼è¦æ±‚"],
        "ç»éªŒæ•™ç¨‹": ["æ•™ç¨‹ä¸»é¢˜", "ç›®æ ‡äººç¾¤", "å·¥å…·/ææ–™", "æ­¥éª¤è¦ç‚¹", "å¸¸è§é—®é¢˜", "é£æ ¼è¦æ±‚"],
        "æ—…è¡Œæ”»ç•¥": ["ç›®çš„åœ°", "æ—…è¡Œå¤©æ•°", "å¿…å»æ™¯ç‚¹", "ç¾é£Ÿæ¨è", "å®ç”¨Tips", "é£æ ¼è¦æ±‚"],
        "ç”Ÿæ´»è®°å½•": ["ä¸»é¢˜å…³é”®è¯", "åœºæ™¯ç»†èŠ‚", "æ—¶é—´/åœ°ç‚¹", "æƒ…æ„ŸåŸºè°ƒ", "æƒ³ä¼ è¾¾çš„ç‚¹", "é£æ ¼è¦æ±‚"]
    }

    # æ£€æŸ¥æ‰€æœ‰å¿…å¡«å­—æ®µ
    missing_fields = []
    for field in required_fields[content_type]:
        if not user_input.get(field):
            missing_fields.append(field)

    # æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if missing_fields:
        field_text = "ã€".join(missing_fields)
        st.error(f"è¯·å¡«å†™ä»¥ä¸‹å¿…å¡«ä¿¡æ¯ï¼š{field_text}ï¼")
    else:
        with spinner("ğŸ§  AIæ­£åœ¨åŠªåŠ›åˆ›ä½œä¸­ï¼Œè¯·ç¨ç­‰..."):
            response = generate_copywriting(opneai_api_key, content_type, user_input)
        st.divider()
        st.markdown("### ğŸ‰ ç”Ÿæˆç»“æœ")
        with st.container():
            st.markdown("#### ğŸ·ï¸ ç”Ÿæˆçš„5ä¸ªæ ‡é¢˜")
            for i, title in enumerate(response.title, 1):
                st.markdown(f"**æ ‡é¢˜{i}**ï¼š{title}")
            st.markdown("#### ğŸ“„ å®Œæ•´æ­£æ–‡å†…å®¹")
            st.write(response.content)